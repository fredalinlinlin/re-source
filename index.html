<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>尋回原檔：最後的筆觸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* =========================================
           CSS STYLES (移植自原專案)
           ========================================= */
        
        /* Base Setup */
        body {
            background-color: #050505;
            color: #c0c0c0;
            margin: 0;
            overflow-x: hidden;
            min-height: 100vh; 
            min-height: 100dvh;
            font-family: monospace;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #a0a0a0; border-radius: 2px; box-shadow: 0 0 5px rgba(255, 255, 255, 0.3); }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glitch Animation */
        @keyframes glitch-anim-1 {
            0% { clip-path: inset(20% 0 80% 0); } 20% { clip-path: inset(60% 0 10% 0); }
            40% { clip-path: inset(40% 0 50% 0); } 60% { clip-path: inset(80% 0 5% 0); }
            80% { clip-path: inset(10% 0 70% 0); } 100% { clip-path: inset(30% 0 20% 0); }
        }
        @keyframes glitch-anim-2 {
            0% { clip-path: inset(10% 0 60% 0); } 20% { clip-path: inset(30% 0 10% 0); }
            40% { clip-path: inset(70% 0 20% 0); } 60% { clip-path: inset(20% 0 50% 0); }
            80% { clip-path: inset(50% 0 10% 0); } 100% { clip-path: inset(5% 0 80% 0); }
        }
        .glitch-layer-1 { animation: glitch-anim-1 2.5s infinite linear alternate-reverse; text-shadow: -2px 0 #fff; }
        .glitch-layer-2 { animation: glitch-anim-2 2s infinite linear alternate-reverse; text-shadow: 2px 0 #555; }

        /* Blink Animation */
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .animate-blink { animation: blink 1s step-end infinite; }

        /* Fade In Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }

        /* --- 3D Card & Holographic Effects --- */
        .perspective-container {
            perspective: 1200px;
        }

        .card-3d {
            transform-style: preserve-3d;
            animation: floatRotate 6s ease-in-out infinite;
            /* Enhanced glowing border */
            box-shadow: 
                0 0 15px rgba(255, 255, 255, 0.1),
                0 0 30px rgba(100, 100, 100, 0.2),
                0 20px 50px rgba(0,0,0,0.9);
            transform-origin: center center;
            will-change: transform;
        }

        @keyframes floatRotate {
            0% { transform: translateY(0) rotateX(4deg) rotateY(-6deg); }
            50% { transform: translateY(-15px) rotateX(-4deg) rotateY(6deg); }
            100% { transform: translateY(0) rotateX(4deg) rotateY(-6deg); }
        }

        .holo-overlay {
            /* 
               SILVER-GRAY HOLOGRAPHIC EFFECT
               Fix: background-repeat: no-repeat prevents the sharp line edge.
            */
            background: linear-gradient(
                115deg, 
                transparent 35%, 
                
                /* Faint outer glow (Cool Silver) */
                rgba(200, 220, 230, 0.05) 42%, 
                
                /* Subtle Rainbow Edge (Left) - Very faint */
                rgba(0, 255, 255, 0.05) 45%,
                
                /* MAIN SILVER BEAM START */
                rgba(255, 255, 255, 0.3) 47%,
                rgba(255, 255, 255, 0.7) 50%,    /* Core White Highlight */
                rgba(255, 255, 255, 0.3) 53%,
                /* MAIN SILVER BEAM END */

                /* Subtle Rainbow Edge (Right) - Very faint */
                rgba(255, 0, 220, 0.05) 55%,

                /* Faint outer glow (Warm Silver) */
                rgba(230, 220, 200, 0.05) 58%,
                
                transparent 65%
            );
            
            background-size: 300% 300%; /* Large size to allow smooth movement */
            background-repeat: no-repeat; /* CRITICAL: Prevents the hard line/seam */
            
            /* mix-blend-mode: soft-light or overlay creates a metallic sheen */
            mix-blend-mode: overlay; 
            
            opacity: 0.9;
            pointer-events: none;
            animation: holoShine 4s ease-in-out infinite;
            z-index: 20;
            transform: translateZ(1px); /* Keep on top */
            filter: brightness(1.2) contrast(1.1);
        }

        @keyframes holoShine {
            0% { background-position: 100% 0%; }
            100% { background-position: -50% 100%; }
        }

        /* Utilities */
        .hidden-screen { display: none !important; }
    </style>
</head>
<body>

    <!-- CRT Overlay Static Effect -->
    <div class="fixed inset-0 pointer-events-none z-50 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.1)_50%),linear-gradient(90deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01),rgba(255,255,255,0.03))] bg-[length:100%_2px,3px_100%] opacity-30 mix-blend-overlay"></div>

    <!-- Main Container -->
    <div id="root" class="w-full h-[100dvh] bg-[#0a0a0a] flex flex-col relative z-10 shadow-[0_0_60px_rgba(0,0,0,0.9)] text-[#c0c0c0] font-mono overflow-hidden">
        <!-- Content will be injected here by JavaScript -->
    </div>

    <script>
        /* =========================================
           DATA & LOGIC (移植自 data.ts)
           ========================================= */
        const scenes = {
            "start": {
                text: "【Q1. 邊界的視角】\n你來到伺服器邊界。這裡重力失衡，空中漂浮著巨大的 3D 漢堡與半截羅馬柱。",
                question: "面對這片混亂，你的第一個動作是？",
                options: [
                    { text: "A. [分析] 觀察材質細節，分析潛在危險。", next: "q2", type: "J" },
                    { text: "B. [感知] 被荒謬感吸引，拍照當作靈感。", next: "q2", type: "P" }
                ]
            },
            "q2": {
                text: "【Q2. 入口的選擇】\n眼前有兩個模糊的入口。左邊發出刺耳雜訊，右邊安靜如黑洞。",
                question: "你決定從哪裡進入？",
                options: [
                    { text: "A. [喧鬧側] 充滿雜訊的崩壞大門", next: "q3_1", type: "E" },
                    { text: "B. [靜謐側] 隱藏在暗處的程式漏洞", next: "q3_2", type: "I" }
                ]
            },
            "q3_1": {
                text: "【喧鬧的遺跡】\n遇到一個全身呈現「紫色方格」的迷途 NPC，正對著空氣撞牆。",
                question: "你會怎麼處理它？",
                options: [
                    { text: "A. [理性] 輸入修復指令，解決路徑錯誤。", next: "q4_1", type: "T" },
                    { text: "B. [情感] 牽起它的手，帶它去安全草地。", next: "q4_2", type: "F" }
                ]
            },
            "q3_2": {
                text: "【靜謐的深淵】\n大廳供奉著「世界名作」，走近一看只是一張畫質極差的貓咪迷因圖。",
                question: "你的第一反應是？",
                options: [
                    { text: "A. [批判] 「就這？」只是普通的低畫質 JPG。", next: "q4_3", type: "T" },
                    { text: "B. [讚嘆] 這是那個時代的「集體潛意識」。", next: "q4_4", type: "F" }
                ]
            },
            "q4_1": {
                text: "【Q4. 損壞的秘密】\n發現發光的「損壞資料夾」，裡面有幾則被刪除的貼文。",
                question: "你會怎麼做？",
                options: [
                    { text: "A. [探究] 修復文字，想知道原本的故事。", next: "q5_1", type: "Ladder" },
                    { text: "B. [謹慎] 可能是病毒，直接走開。", next: "q5_2", type: "Core" }
                ]
            },
            "q4_2": {
                text: "【Q4. 斷裂的裂谷】\n前方出現數據裂谷。周圍有橡皮鴨、輪胎等廢棄物。",
                question: "你會如何通過？",
                options: [
                    { text: "A. [規劃] 繪製藍圖，搭建穩定橋樑。", next: "q5_1", type: "Ladder" },
                    { text: "B. [直覺] 即興拼湊，黏在一起試試。", next: "q5_2", type: "Core" }
                ]
            },
            "q4_3": {
                text: "【Q4. 隱藏的檔案室】\n發現隱藏的檔案室，堆滿了開發日誌與廢案。",
                question: "你會？",
                options: [
                    { text: "A. [分析] 掃描關鍵字，過濾垃圾資訊。", next: "q5_1", type: "Ladder" },
                    { text: "B. [閱讀] 隨機拿起閱讀，拼湊開發者意圖。", next: "q5_2", type: "Core" }
                ]
            },
            "q4_4": {
                text: "【Q4. 凝結的房間】\n發現一個被完整保留的「玩家房間」，充滿 20 年前的生活感。",
                question: "你會？",
                options: [
                    { text: "A. [搜索] 翻找櫃子，尋找隱藏道具。", next: "q5_1", type: "Ladder" },
                    { text: "B. [體驗] 坐在電腦椅上，看著窗外風景。", next: "q5_2", type: "Core" }
                ]
            },
            "q5_1": {
                text: "【終極二選一：梯子與境界】\n你理解了通往原創之路是由無數碎片堆疊而成，像是一把梯子。",
                question: "你會怎麼做？",
                options: [
                    { text: "A. 意識到尋找無意義，拋棄梯子。", next: "end", type: "Deconstruct" },
                    { text: "B. 決定沿著碎片攀爬，建構唯一解答。", next: "end", type: "Construct" }
                ]
            },
            "q5_2": {
                text: "【終極二選一：核心與世界】\n你找到了世界的核心電池。取走它，世界就會崩塌。",
                question: "你會？",
                options: [
                    { text: "A. 拔出它。為了真實，毀滅夢境。", next: "end", type: "Destroy" },
                    { text: "B. 放開手。為了回憶，保存現狀。", next: "end", type: "Preserve" }
                ]
            }
        };

        const characters = {
            "ARCHAEOLOGIST": { name: "廢話考古學家", title: "The Nonsense Archaeologist", rarity: "★★★ 極稀有", item: "備份硬碟", desc: "嚴謹的紀錄者。你把過去的廢文當作史詩研究，守護著舊時代的記憶。" },
            "JANITOR": { name: "快取清潔工", title: "The Cache Janitor", rarity: "★★☆ 稀有", item: "強制刪除按鈕", desc: "秩序的維護者。你無法容忍混亂，在廢墟中建立新的規則。" },
            "COLLECTIVE": { name: "預設集合體", title: "The Default Collective", rarity: "★☆☆ 普及", item: "新手禮包", desc: "群體的連結者。你是所有初始角色的混合體，重視大家的和諧。" },
            "SURFER": { name: "超連結衝浪手", title: "The Hyperlink Surfer", rarity: "★★★ 極稀有", item: "藍色底線", desc: "創意的冒險家。你在隨機與混亂中尋找新的可能性。" },
            "WATCHER": { name: "虛空凝視者", title: "The Void Watcher", rarity: "★★★ 極稀有", item: "系統日誌", desc: "冷靜的觀察者。你漂浮在深淵，試圖看透程式碼背後的終極邏輯。" },
            "POET": { name: "亂碼詩人", title: "The Mojibake Poet", rarity: "★★★ 極稀有", item: "翻譯蒟蒻", desc: "深邃的解讀者。你能將無意義的亂碼轉化為動人的詩篇。" },
            "SPEEDRUNNER": { name: "速通跑者", title: "The Speedrunner", rarity: "★★★ 極稀有", item: "計時器", desc: "刺激的追求者。你只想用最快速度衝到終點，利用 Bug 來抄捷徑。" },
            "PUNKR": { name: "數位龐克樂手", title: "The Cyber PunkR", rarity: "★★★ 極稀有", item: "破音效果器", desc: "舞台的巨星。你把世界末日變成一場狂歡派對。" },
            "MODDER": { name: "模組改裝師", title: "The Modder", rarity: "★★★ 極稀有", item: "萬能扳手", desc: "實用的改造者。你只在乎如何把手邊的廢棄物改裝成超酷的道具。" },
            "WEAVER": { name: "碎片編織者", title: "The Fragment Weaver", rarity: "★★★ 極稀有", item: "數位膠水", desc: "感性的藝術家。你能欣賞崩壞之美，將不相關的碎片拼成全新的藝術。" },
            "DRIFTER": { name: "邊界漂流者", title: "The Hitbox Drifter", rarity: "★★★ 極稀有", item: "穿牆指令", desc: "邏輯的叛逆者。你不走尋常路，探索地圖邊界外的未知虛空。" },
            "MISSING": { name: "紫黑缺失者", title: "The Missing Texture", rarity: "★★☆ 稀有", item: "損壞的鏡子", desc: "迷惘的夢想家。失去了外表貼圖，卻擁有一顆敏感而細膩的心。" }
        };

        function calculateCharacterID(scores) {
            const { Q2, Q3, Q4, Final } = scores;
            // Route A: E-T
            if (Q2 === "E" && Q3 === "T") {
                if (Q4 === "Ladder" && Final === "Deconstruct") return "JANITOR";
                if (Q4 === "Ladder" && Final === "Construct") return "SPEEDRUNNER";
                if (Q4 === "Core" && Final === "Destroy") return "JANITOR";
                if (Q4 === "Core" && Final === "Preserve") return "COLLECTIVE";
            }
            // Route B: E-F
            if (Q2 === "E" && Q3 === "F") {
                if (Q4 === "Ladder" && Final === "Deconstruct") return "SURFER";
                if (Q4 === "Ladder" && Final === "Construct") return "PUNKR";
                if (Q4 === "Core" && Final === "Destroy") return "MISSING";
                if (Q4 === "Core" && Final === "Preserve") return "COLLECTIVE";
            }
            // Route C: I-T
            if (Q2 === "I" && Q3 === "T") {
                if (Q4 === "Ladder" && Final === "Deconstruct") return "WATCHER";
                if (Q4 === "Ladder" && Final === "Construct") return "MODDER";
                if (Q4 === "Core" && Final === "Destroy") return "DRIFTER";
                if (Q4 === "Core" && Final === "Preserve") return "ARCHAEOLOGIST";
            }
            // Route D: I-F
            if (Q2 === "I" && Q3 === "F") {
                if (Q4 === "Ladder" && Final === "Deconstruct") return "MISSING";
                if (Q4 === "Ladder" && Final === "Construct") return "POET";
                if (Q4 === "Core" && Final === "Destroy") return "WEAVER";
                if (Q4 === "Core" && Final === "Preserve") return "COLLECTIVE";
            }
            return "COLLECTIVE"; // Fallback
        }

        /* =========================================
           APP STATE MANAGEMENT
           ========================================= */
        const state = {
            view: 'INTRO', // INTRO, UPLOAD, GAME, PROCESSING, RESULT_AVATAR, RESULT_SCENE
            currentSceneId: 'start',
            scores: { Q2: '', Q3: '', Q4: '', Final: '' },
            pathStep: 0,
            userImage: null,
            charId: null
        };

        const root = document.getElementById('root');
        let currentTypewriterInterval = null;
        let currentProcessInterval = null;

        /* =========================================
           RENDER FUNCTIONS
           ========================================= */

        function render() {
            // Clear previous intervals to prevent memory leaks/glitches
            if (currentTypewriterInterval) clearInterval(currentTypewriterInterval);
            if (currentProcessInterval) clearInterval(currentProcessInterval);
            
            root.innerHTML = ''; // Clear container

            switch (state.view) {
                case 'INTRO':
                    renderIntro();
                    break;
                case 'UPLOAD':
                    renderUpload();
                    break;
                case 'GAME':
                    renderGame();
                    break;
                case 'PROCESSING':
                    renderProcessing();
                    break;
                case 'RESULT_AVATAR':
                    renderResult('avatar');
                    break;
                case 'RESULT_SCENE':
                    renderResult('scene');
                    break;
            }
        }

        // --- View: Intro ---
        function renderIntro() {
            const container = document.createElement('div');
            container.className = "flex flex-col h-full p-6 pb-20 justify-center animate-fadeIn max-w-2xl mx-auto w-full";
            
            container.innerHTML = `
                <div class="text-center mb-12">
                    <h1 class="text-4xl md:text-6xl text-[#e0e0e0] font-bold drop-shadow-[0_0_15px_rgba(255,255,255,0.5)] mb-4 leading-none tracking-[0.2em] relative group cursor-default">
                        <span class="relative z-10 text-[#e0e0e0]">RE:SOURCE</span>
                        <span class="absolute top-0 left-[2px] w-full h-full text-[#a0a0a0] z-0 opacity-75 animate-[glitch-anim-1_2.5s_infinite_linear_alternate-reverse] hidden group-hover:block" style="text-shadow: -2px 0 #fff" aria-hidden="true">RE:SOURCE</span>
                        <span class="absolute top-0 -left-[2px] w-full h-full text-[#808080] z-0 opacity-75 animate-[glitch-anim-2_2s_infinite_linear_alternate-reverse] hidden group-hover:block" style="text-shadow: 2px 0 #555" aria-hidden="true">RE:SOURCE</span>
                    </h1>
                    <div class="text-lg md:text-xl text-[#888] font-light tracking-[0.5em] uppercase border-t border-[#333] pt-4 inline-block">尋回原檔</div>
                </div>
                
                <div class="text-sm md:text-base text-[#aaa] leading-relaxed mb-12 border-l border-[#444] pl-6 py-2">
                    <p class="mb-4">時間是 2046 年。</p>
                    <p class="mb-4">所有的創作都已破碎，化為漂浮在數位世界中的殘骸。</p>
                    <p>準備好尋找你遺失的「完全原創之物」了嗎？</p>
                </div>

                <button id="btn-start" class="w-full py-4 bg-gradient-to-r from-[#666] via-[#bbb] to-[#666] text-black font-bold text-lg hover:via-[#fff] hover:shadow-[0_0_20px_rgba(255,255,255,0.5)] transition-all duration-300 tracking-[0.2em]">
                    連線至伺服器
                </button>
            `;

            root.appendChild(container);
            document.getElementById('btn-start').addEventListener('click', () => {
                state.view = 'UPLOAD';
                render();
            });
        }

        // --- View: Upload ---
        function renderUpload() {
            const container = document.createElement('div');
            container.className = "p-6 pb-20 h-full max-w-2xl mx-auto w-full flex flex-col justify-center animate-fadeIn";

            container.innerHTML = `
                <div class="flex justify-between text-xs sm:text-sm text-[#888] border-b border-[#333] pb-2 mb-4 tracking-widest">
                    <span>STEP: 身份同步</span>
                    <span>STATUS: WAITING</span>
                </div>
                
                <div class="text-center text-[#ccc] mb-6 text-sm sm:text-base leading-relaxed">
                    請上傳一張照片以建立神經連結。<br />
                    <span class="text-xs text-[#666] font-mono">(此照片將用於生成你的數位化身)</span>
                </div>

                <input type="file" id="file-input" accept="image/*" class="hidden" />
                
                <div id="upload-area" class="border border-dashed border-[#666] rounded-sm h-[250px] sm:h-[300px] flex flex-col justify-center items-center cursor-pointer transition-all duration-300 hover:bg-[#151515] hover:border-[#fff] hover:shadow-[0_0_20px_rgba(255,255,255,0.15)] relative overflow-hidden bg-[#0c0c0c] mb-6 group">
                    <div id="upload-placeholder" class="text-center group-hover:scale-105 transition-transform">
                        <div class="text-6xl text-[#444] group-hover:text-[#e0e0e0] mb-4 font-thin">+</div>
                        <div class="text-[#666] group-hover:text-[#e0e0e0] tracking-widest text-sm">點擊拍攝或上傳</div>
                    </div>
                    <img id="preview-img" class="w-full h-full object-contain hidden" />
                </div>

                <button id="btn-sync" disabled class="mt-auto w-full py-4 text-black font-bold text-lg font-mono transition-all duration-300 uppercase tracking-[0.2em] border border-[#666] bg-[#1a1a1a] text-[#444] border-[#333] cursor-not-allowed">
                    開始同步並進入廢墟
                </button>
            `;

            root.appendChild(container);

            const fileInput = document.getElementById('file-input');
            const uploadArea = document.getElementById('upload-area');
            const previewImg = document.getElementById('preview-img');
            const placeholder = document.getElementById('upload-placeholder');
            const btnSync = document.getElementById('btn-sync');
            let uploadedImgData = null;

            uploadArea.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        uploadedImgData = ev.target.result;
                        previewImg.src = uploadedImgData;
                        previewImg.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                        
                        // Enable button
                        btnSync.disabled = false;
                        btnSync.className = "mt-auto w-full py-4 text-black font-bold text-lg font-mono transition-all duration-300 uppercase tracking-[0.2em] border border-[#666] bg-gradient-to-r from-[#888] via-[#e0e0e0] to-[#888] hover:shadow-[0_0_25px_rgba(255,255,255,0.4)] cursor-pointer";
                    };
                    reader.readAsDataURL(file);
                }
            });

            btnSync.addEventListener('click', () => {
                if (uploadedImgData) {
                    state.userImage = uploadedImgData;
                    state.view = 'GAME';
                    state.scores = { Q2: '', Q3: '', Q4: '', Final: '' };
                    state.currentSceneId = 'start';
                    state.pathStep = 0;
                    render();
                }
            });
        }

        // --- View: Game ---
        function renderGame() {
            const currentScene = scenes[state.currentSceneId];
            const progress = Math.min((state.pathStep / 5) * 100, 100);

            const container = document.createElement('div');
            container.className = "flex flex-col h-full p-5 max-w-3xl mx-auto w-full";

            container.innerHTML = `
                <div class="flex justify-between text-xs text-[#666] border-b border-[#333] pb-2 mb-4 shrink-0 font-mono tracking-widest">
                  <span>LOC: LAYER_0</span>
                  <div class="w-[100px] h-2 border border-[#444] p-[1px] bg-[#000]">
                    <div class="h-full bg-[#ccc] shadow-[0_0_5px_rgba(255,255,255,0.5)] transition-all duration-300" style="width: ${progress}%"></div>
                  </div>
                </div>

                <div id="game-scroll-area" class="flex-grow overflow-y-auto mb-4 scrollbar-hide">
                    <div id="typewriter-text" class="text-lg md:text-xl leading-relaxed text-[#d0d0d0] mb-8 drop-shadow-[0_1px_1px_rgba(0,0,0,0.8)] whitespace-pre-wrap relative"></div>
                    <div id="scene-question" class="text-[#fff] font-bold mb-6 border-l-2 border-[#fff] pl-4 animate-fadeIn shadow-[0_0_15px_rgba(255,255,255,0.05)] py-3 bg-[#ffffff05] tracking-wide text-lg hidden">
                       ${currentScene.question}
                    </div>
                </div>

                <div id="options-container" class="flex flex-col gap-4 mt-auto pb-20 sm:pb-6 hidden"></div>
            `;
            
            root.appendChild(container);

            // Logic: Typewriter
            const textElement = document.getElementById('typewriter-text');
            const questionElement = document.getElementById('scene-question');
            const optionsContainer = document.getElementById('options-container');
            const scrollArea = document.getElementById('game-scroll-area');
            const fullText = currentScene.text;
            let charIndex = 0;

            // Render options but keep hidden
            currentScene.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "text-left p-5 border border-[#444] text-[#aaa] bg-[#0f0f0f] hover:bg-[#ccc] hover:text-black hover:border-[#fff] hover:shadow-[0_0_20px_rgba(255,255,255,0.5)] transition-all duration-300 active:scale-[0.99] md:text-lg opacity-0";
                btn.style.animation = `fadeIn 0.5s ease forwards ${idx * 0.1}s`;
                btn.innerHTML = `<span class="font-bold mr-2">[${String.fromCharCode(65 + idx)}]</span> ${opt.text.substring(3)}`;
                
                btn.addEventListener('click', () => {
                   handleOptionClick(opt);
                });
                optionsContainer.appendChild(btn);
            });

            currentTypewriterInterval = setInterval(() => {
                if (charIndex < fullText.length) {
                    textElement.textContent += fullText.charAt(charIndex);
                    // Add blink cursor
                    textElement.innerHTML = textElement.textContent + '<span class="inline-block w-[10px] h-[1.2em] bg-[#c0c0c0] animate-blink align-text-bottom ml-1 shadow-[0_0_8px_#ffffff]"></span>';
                    charIndex++;
                    scrollArea.scrollTop = scrollArea.scrollHeight;
                } else {
                    clearInterval(currentTypewriterInterval);
                    // Remove cursor after a bit or keep it
                    setTimeout(() => {
                        questionElement.classList.remove('hidden');
                        optionsContainer.classList.remove('hidden');
                        scrollArea.scrollTop = scrollArea.scrollHeight;
                    }, 300);
                }
            }, 20);
        }

        function handleOptionClick(option) {
            // Logic Mapping
            if (['E', 'I'].includes(option.type)) state.scores.Q2 = option.type;
            if (['T', 'F'].includes(option.type)) state.scores.Q3 = option.type;
            if (['Ladder', 'Core'].includes(option.type)) state.scores.Q4 = option.type;
            if (option.next === 'end') state.scores.Final = option.type;
            
            state.pathStep++;

            if (option.next === 'end') {
                state.view = 'PROCESSING';
            } else {
                state.currentSceneId = option.next;
            }
            render();
        }

        // --- View: Processing ---
        function renderProcessing() {
            state.charId = calculateCharacterID(state.scores);
            const container = document.createElement('div');
            container.className = "p-6 h-full flex flex-col justify-center max-w-2xl mx-auto w-full animate-fadeIn";

            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <div class="w-[80px] h-[80px] relative mb-10">
                        <div class="absolute inset-0 border-4 border-[#333] rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-t-[#e0e0e0] border-r-[#e0e0e0] border-b-transparent border-l-transparent rounded-full animate-spin shadow-[0_0_15px_rgba(255,255,255,0.2)]"></div>
                    </div>
                    
                    <div class="text-xl text-[#e0e0e0] mb-6 font-mono tracking-[0.2em] uppercase drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]">
                        重組原創數據中
                    </div>
                    
                    <div id="console-logs" class="font-mono text-xs text-[#888] text-left w-full max-w-[320px] h-[160px] overflow-hidden border border-[#222] p-4 bg-[#080808]">
                        <div class="animate-blink inline-block w-2 h-4 bg-[#666] align-middle ml-2" id="cursor-log"></div>
                    </div>
                </div>
            `;
            root.appendChild(container);

            const messages = [
                "正在分析神經連結...",
                `偵測到靈魂特質: [${state.charId}]`,
                "正在連接 ComfyUI 節點...",
                "Loading LoRA: Future_Chrome_v9...",
                "生成大頭貼...",
                "合成場景..."
            ];
            
            const logContainer = document.getElementById('console-logs');
            const cursor = document.getElementById('cursor-log');
            let i = 0;

            currentProcessInterval = setInterval(() => {
                if (i < messages.length) {
                    const line = document.createElement('div');
                    line.className = "mb-2 border-l border-[#444] pl-2";
                    line.textContent = `> ${messages[i]}`;
                    logContainer.insertBefore(line, cursor);
                    i++;
                } else {
                    clearInterval(currentProcessInterval);
                    setTimeout(() => {
                        state.view = 'RESULT_AVATAR';
                        render();
                    }, 1000);
                }
            }, 800);
        }

        // --- View: Result (Avatar/Scene) ---
        function renderResult(type) {
            const isAvatar = type === 'avatar';
            // Assuming images are in the root directory as per instructions
            const avatarUrl = "./result_card_example.png";
            const sceneUrl = "./scenario_card_example.png";
            const currentImageUrl = isAvatar ? avatarUrl : sceneUrl;
            
            const container = document.createElement('div');
            container.className = "h-full flex flex-col bg-[#050505] relative overflow-hidden animate-fadeIn border-t border-[#333] shadow-[0_0_30px_rgba(255,255,255,0.05)] w-full";

            container.innerHTML = `
                <!-- 3D Card Container -->
                <div class="flex-grow relative w-full overflow-hidden bg-[#0a0a0a] flex items-center justify-center perspective-container py-4">
                    <!-- Subtle Grid Background -->
                    <div class="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.02)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:40px_40px] pointer-events-none"></div>

                    <!-- Card Wrapper -->
                    <div id="card-wrapper" class="card-3d relative h-[60vh] md:h-[70vh] w-auto aspect-[9/16] rounded-lg overflow-hidden bg-black border border-[#444] shadow-2xl">
                        
                        <!-- Base Image Layer (Z-10) -->
                        <img 
                            src="${currentImageUrl}" 
                            alt="${isAvatar ? "Result Card" : "Scenario Card"}" 
                            class="w-full h-full object-cover relative z-10 block"
                            onerror="this.onerror=null;this.src='https://placehold.co/1080x1920/222/aaa?text=${isAvatar ? 'Missing+Img' : 'Missing+Img'}';"
                        />
                        
                        <!-- Holographic Overlay Layer (Z-20) -->
                        <div class="holo-overlay absolute inset-0 z-20 pointer-events-none"></div>
                        
                        <!-- Border/Highlight Layer (Z-30) -->
                        <div class="absolute inset-0 border border-[#ffffff44] rounded-lg pointer-events-none z-30"></div>
                    </div>
                </div>

                <!-- Action Button Area -->
                <div class="w-full p-4 pb-12 sm:pb-6 bg-[#050505] border-t border-[#333] relative z-40 flex gap-3 shadow-[0_-5px_20px_rgba(0,0,0,0.8)] max-w-4xl mx-auto shrink-0">
                    <button id="btn-download" class="flex-1 py-4 bg-[#111] text-[#888] font-bold font-mono text-sm tracking-widest border border-[#333] hover:bg-[#222] hover:text-[#fff] transition-all duration-300 active:scale-[0.98]">
                    下載
                    </button>

                    <button id="btn-next" class="flex-[2] py-4 bg-gradient-to-r from-[#4b5563] via-[#d1d5db] to-[#4b5563] text-black font-bold font-mono text-base tracking-[0.2em] transition-all duration-300 shadow-[0_0_15px_rgba(255,255,255,0.1)] hover:shadow-[0_0_25px_rgba(255,255,255,0.4)] hover:brightness-110 active:scale-[0.99] border border-[#9ca3af]">
                    ${isAvatar ? '下一頁 >>' : 'RESTART'}
                    </button>
                </div>
                
                <!-- Dev Info -->
                <div class="absolute top-4 right-4 text-[10px] text-[#555] font-mono tracking-widest pointer-events-none opacity-50">
                    ID: ${state.charId}
                </div>
            `;
            
            root.appendChild(container);

            document.getElementById('btn-download').addEventListener('click', () => {
                const link = document.createElement('a');
                link.href = currentImageUrl;
                link.download = `RE_SOURCE_${isAvatar ? 'RESULT' : 'SCENARIO'}_${state.charId}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            document.getElementById('btn-next').addEventListener('click', () => {
                if (isAvatar) {
                    state.view = 'RESULT_SCENE';
                } else {
                    state.view = 'INTRO';
                }
                render();
            });
        }

        // --- Init ---
        render();

    </script>
</body>
</html>